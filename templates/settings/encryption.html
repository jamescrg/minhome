{% extends "settings/main.html" %}
{% load static %}
{% block subcontent %}
    {% csrf_token %}
    <div class="card">
        <div class="card-title">
            <h1>Notes Encryption</h1>
        </div>
        <p class="card-text">
            End-to-end encryption uses a standalone passphrase to derive an AES-256 key.
            The key is stored in this browser's local storage and never sent to the server.
            This passphrase is independent of your login password.
        </p>
        <table class="options">
            <tr>
                <td class="setting-label">Status:</td>
                <td class="setting-control">
                    <span id="encryption-status">
                        {% if has_salt %}
                            <span style="color:var(--green-600)">Enabled</span>
                        {% else %}
                            Disabled
                        {% endif %}
                    </span>
                </td>
            </tr>
            {% if has_salt %}
                <tr>
                    <td class="setting-label">Notes:</td>
                    <td class="setting-control">
                        <span id="encryption-stats">{{ encrypted_count }} of {{ note_count }} encrypted</span>
                    </td>
                </tr>
                <tr>
                    <td class="setting-label">Key:</td>
                    <td class="setting-control">
                        <span id="key-status"></span>
                    </td>
                </tr>
            {% endif %}
        </table>
        <div style="margin-top:1.25rem">
            {% if not has_salt %}
                <!-- State: Disabled — show passphrase + confirm to enable -->
                <div id="enable-section">
                    <p class="card-text" style="margin-bottom:0.75rem">Choose a passphrase to enable encryption:</p>
                    <div style="display:flex;flex-direction:column;gap:0.5rem;max-width:20rem">
                        <div class="password-wrapper">
                            <input type="password"
                                   id="enable-passphrase"
                                   class="form-control"
                                   placeholder="Passphrase"
                                   autocomplete="off">
                            <button type="button" class="password-toggle" aria-label="Toggle visibility">
                                <i class="icon-eye-off"></i>
                            </button>
                        </div>
                        <div class="password-wrapper">
                            <input type="password"
                                   id="enable-passphrase-confirm"
                                   class="form-control"
                                   placeholder="Confirm passphrase"
                                   autocomplete="off">
                            <button type="button" class="password-toggle" aria-label="Toggle visibility">
                                <i class="icon-eye-off"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button"
                            class="btn btn-primary"
                            style="margin-top:0.75rem"
                            id="enable-btn">Enable Encryption</button>
                </div>
            {% else %}
                <!-- State: Enabled — key loaded or not loaded -->
                <div id="key-loaded-section" style="display:none">
                    <button type="button" class="btn btn-danger" id="disable-loaded-btn">Disable Encryption</button>
                </div>
                <div id="no-key-section" style="display:none">
                    <p class="card-text" style="margin-bottom:0.75rem">Enter the passphrase used to encrypt your notes:</p>
                    <div class="password-wrapper" style="max-width:20rem">
                        <input type="password"
                               id="passphrase-input"
                               class="form-control"
                               placeholder="Encryption passphrase"
                               autocomplete="off">
                        <button type="button" class="password-toggle" aria-label="Toggle visibility">
                            <i class="icon-eye-off"></i>
                        </button>
                    </div>
                    <div style="display:flex;gap:0.75rem;margin-top:0.75rem">
                        <button type="button" class="btn btn-primary btn-slim" id="load-key-btn">Load Key</button>
                        <button type="button" class="btn btn-danger btn-slim" id="disable-nokey-btn">Disable Encryption</button>
                    </div>
                </div>
            {% endif %}
            <div id="encryption-progress" style="display:none;margin-top:1rem">
                <div style="display:flex;align-items:center;gap:0.75rem">
                    <span id="progress-text"
                          style="font-size:0.85rem;
                                 color:var(--color-secondary)"></span>
                </div>
            </div>
            <p id="encryption-message" style="margin-top:0.75rem;font-size:0.85rem"></p>
        </div>
        <p class="card-text"
           style="margin-top:1.5rem;
                  color:var(--stone-500);
                  font-size:0.85rem">
            <i class="icon-triangle-alert" style="font-size:0.85rem"></i>
            If you clear browser data or use a different browser, return here and enter your passphrase to reload the key.
            Changing your login password does not affect encryption.
        </p>
    </div>
    <style>
    .password-wrapper {
        position: relative;
    }
    .password-wrapper input {
        padding-right: 2.5rem;
    }
    .password-toggle {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: var(--color-secondary);
        padding: 0.25rem;
        display: flex;
        align-items: center;
    }
    .password-toggle:hover {
        color: var(--color-primary);
    }
    .password-toggle i {
        font-size: 1rem;
    }
    </style>
    <script>
    document.querySelectorAll(".password-toggle").forEach(function(btn) {
      btn.addEventListener("click", function() {
        const input = btn.parentElement.querySelector("input");
        const icon = btn.querySelector("i");
        if (input.type === "password") {
          input.type = "text";
          icon.className = "icon-eye";
        } else {
          input.type = "password";
          icon.className = "icon-eye-off";
        }
      });
    });
    </script>
    <script type="module">
    import { generateSalt, deriveKey, encrypt, decrypt, storeKey, getStoredKey, hasStoredKey, clearStoredKey } from "{% static 'js/crypto.js' %}";

    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    const messageEl = document.getElementById("encryption-message");
    const progressEl = document.getElementById("encryption-progress");
    const progressText = document.getElementById("progress-text");

    function showMessage(text, isError) {
      messageEl.textContent = text;
      messageEl.style.color = isError ? "var(--red-600)" : "var(--green-600)";
    }

    function showProgress(text) {
      progressEl.style.display = "";
      progressText.textContent = text;
    }

    function hideProgress() {
      progressEl.style.display = "none";
    }

    async function fetchNotes() {
      const resp = await fetch("{% url 'settings-encryption-notes' %}", {
        headers: { "X-CSRFToken": csrfToken },
      });
      const data = await resp.json();
      return data.notes;
    }

    async function saveNotes(notes) {
      const resp = await fetch("{% url 'settings-encryption-notes-update' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" },
        body: JSON.stringify({ notes: notes }),
      });
      return resp.ok;
    }

    async function bulkEncrypt(key) {
      showProgress("Fetching notes...");
      const notes = await fetchNotes();
      const toEncrypt = notes.filter(function(n) { return !n.is_encrypted && n.content; });

      if (toEncrypt.length > 0) {
        const updates = [];
        for (let i = 0; i < toEncrypt.length; i++) {
          showProgress("Encrypting note " + (i + 1) + " of " + toEncrypt.length + "...");
          const encrypted = await encrypt(toEncrypt[i].content, key);
          updates.push({ id: toEncrypt[i].id, content: encrypted, is_encrypted: true });
        }
        showProgress("Saving encrypted notes...");
        await saveNotes(updates);
      }
    }

    async function bulkDecrypt(key) {
      showProgress("Fetching notes...");
      const notes = await fetchNotes();
      const toDecrypt = notes.filter(function(n) { return n.is_encrypted && n.content; });

      if (toDecrypt.length > 0) {
        const updates = [];
        for (let i = 0; i < toDecrypt.length; i++) {
          showProgress("Decrypting note " + (i + 1) + " of " + toDecrypt.length + "...");
          const plaintext = await decrypt(toDecrypt[i].content, key);
          updates.push({ id: toDecrypt[i].id, content: plaintext, is_encrypted: false });
        }
        showProgress("Saving decrypted notes...");
        await saveNotes(updates);
      }
    }

    async function clearSalt() {
      await fetch("{% url 'settings-encryption-clear-salt' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" },
      });
    }

    // ── State: Disabled — Enable encryption ──
    const enableBtn = document.getElementById("enable-btn");
    const passphraseInput = document.getElementById("enable-passphrase");
    const passphraseConfirm = document.getElementById("enable-passphrase-confirm");

    if (enableBtn) {
      enableBtn.addEventListener("click", async function() {
        const passphrase = passphraseInput.value;
        const confirm = passphraseConfirm.value;

        if (!passphrase) {
          showMessage("Passphrase cannot be empty.", true);
          return;
        }
        if (passphrase !== confirm) {
          showMessage("Passphrases do not match.", true);
          return;
        }

        enableBtn.disabled = true;
        messageEl.textContent = "";

        try {
          showProgress("Generating encryption key...");
          const salt = generateSalt();
          const resp = await fetch("{% url 'settings-encryption-save-salt' %}", {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" },
            body: JSON.stringify({ salt: salt }),
          });
          if (!resp.ok) {
            showMessage("Failed to save encryption settings.", true);
            enableBtn.disabled = false;
            hideProgress();
            return;
          }

          const key = await deriveKey(passphrase, salt);
          await storeKey(key);
          await bulkEncrypt(key);

          hideProgress();
          showMessage("Encryption enabled. All notes are now encrypted.", false);
          setTimeout(function() { location.reload(); }, 1000);
        } catch (e) {
          hideProgress();
          showMessage("Error: " + e.message, true);
          enableBtn.disabled = false;
        }
      });

      passphraseConfirm.addEventListener("keydown", function(e) {
        if (e.key === "Enter") enableBtn.click();
      });
    }

    // ── State: Enabled — show correct sub-state ──
    const keyStatusEl = document.getElementById("key-status");
    const keyLoadedSection = document.getElementById("key-loaded-section");
    const noKeySection = document.getElementById("no-key-section");

    if (keyStatusEl) {
      if (hasStoredKey()) {
        keyStatusEl.innerHTML = '<span style="color:var(--green-600)">Loaded in this browser</span>';
        if (keyLoadedSection) keyLoadedSection.style.display = "";
      } else {
        keyStatusEl.textContent = "Not loaded in this browser";
        if (noKeySection) noKeySection.style.display = "";
      }
    }

    // ── Load Key (no-key sub-state) ──
    const loadKeyBtn = document.getElementById("load-key-btn");
    const noKeyPassphrase = document.getElementById("passphrase-input");

    if (loadKeyBtn) {
      loadKeyBtn.addEventListener("click", async function() {
        const passphrase = noKeyPassphrase.value;
        if (!passphrase) {
          showMessage("Please enter the passphrase.", true);
          return;
        }

        loadKeyBtn.disabled = true;
        messageEl.textContent = "";

        try {
          const salt = "{{ user.encryption_salt|escapejs }}";
          showProgress("Deriving key from passphrase...");
          const key = await deriveKey(passphrase, salt);
          await storeKey(key);

          hideProgress();
          showMessage("Key loaded successfully.", false);
          setTimeout(function() { location.reload(); }, 1000);
        } catch (e) {
          hideProgress();
          showMessage("Error: " + e.message, true);
          loadKeyBtn.disabled = false;
        }
      });

      noKeyPassphrase.addEventListener("keydown", function(e) {
        if (e.key === "Enter") loadKeyBtn.click();
      });
    }

    // ── Disable Encryption (key-loaded sub-state) ──
    const disableLoadedBtn = document.getElementById("disable-loaded-btn");
    if (disableLoadedBtn) {
      disableLoadedBtn.addEventListener("click", async function() {
        const confirmed = await window.showConfirm({
          title: "Disable Encryption",
          message: "This will decrypt all notes and store them as plaintext. Continue?",
          confirmText: "Disable Encryption",
          isDangerous: true,
        });
        if (!confirmed) return;

        disableLoadedBtn.disabled = true;
        messageEl.textContent = "";

        try {
          const key = await getStoredKey();
          await bulkDecrypt(key);

          showProgress("Clearing encryption settings...");
          await clearSalt();
          clearStoredKey();

          hideProgress();
          showMessage("Encryption disabled. All notes are now plaintext.", false);
          setTimeout(function() { location.reload(); }, 1000);
        } catch (e) {
          hideProgress();
          showMessage("Error: " + e.message, true);
          disableLoadedBtn.disabled = false;
        }
      });
    }

    // ── Disable Encryption (no-key sub-state) ──
    const disableNoKeyBtn = document.getElementById("disable-nokey-btn");
    if (disableNoKeyBtn) {
      disableNoKeyBtn.addEventListener("click", async function() {
        const passphrase = noKeyPassphrase.value;
        if (!passphrase) {
          showMessage("Please enter the passphrase to decrypt notes.", true);
          return;
        }

        const confirmed = await window.showConfirm({
          title: "Disable Encryption",
          message: "This will decrypt all notes and store them as plaintext. Continue?",
          confirmText: "Disable Encryption",
          isDangerous: true,
        });
        if (!confirmed) return;

        disableNoKeyBtn.disabled = true;
        messageEl.textContent = "";

        try {
          const salt = "{{ user.encryption_salt|escapejs }}";
          showProgress("Deriving key from passphrase...");
          const key = await deriveKey(passphrase, salt);

          await bulkDecrypt(key);

          showProgress("Clearing encryption settings...");
          await clearSalt();
          clearStoredKey();

          hideProgress();
          showMessage("Encryption disabled. All notes are now plaintext.", false);
          setTimeout(function() { location.reload(); }, 1000);
        } catch (e) {
          hideProgress();
          showMessage("Error: " + e.message, true);
          disableNoKeyBtn.disabled = false;
        }
      });
    }
    </script>
{% endblock subcontent %}
